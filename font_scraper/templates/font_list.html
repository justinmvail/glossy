<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>FTS: Fonts To Strokes</title>
<style>
  body { font-family: system-ui, sans-serif; margin: 0; padding: 20px; background: #1a1a2e; color: #eee; }
  h1 { margin-bottom: 5px; }
  .subtitle { color: #888; margin-bottom: 20px; }
  .controls { display: flex; gap: 15px; align-items: center; margin-bottom: 15px; flex-wrap: wrap; }
  table { border-collapse: collapse; width: 100%; max-width: 1400px; }
  .font-sample { height: 36px; max-width: 300px; vertical-align: middle; }
  th, td { text-align: left; padding: 8px 12px; border-bottom: 1px solid #333; }
  th { color: #888; font-weight: 600; }
  th.sortable { cursor: pointer; user-select: none; }
  th.sortable:hover { color: #7eb8f7; }
  th.sortable::after { content: ''; margin-left: 5px; }
  th.sort-asc::after { content: ' \u25B2'; }
  th.sort-desc::after { content: ' \u25BC'; }
  a { color: #7eb8f7; text-decoration: none; }
  a:hover { text-decoration: underline; }
  .count { color: #888; }
  .source { font-size: 0.85em; color: #666; }
  input[type=text] { padding: 6px 10px; border: 1px solid #444; background: #222; color: #eee;
    border-radius: 4px; width: 200px; }
  .btn {
    padding: 4px 10px; border: 1px solid #444; background: #222; color: #eee;
    border-radius: 4px; cursor: pointer; font-size: 12px;
  }
  .btn:hover { background: #333; }
  .btn:disabled { opacity: 0.5; cursor: not-allowed; }
  .btn.reject { border-color: #a55; color: #f88; }
  .btn.reject:hover { background: #422; }
  .btn.unreject { border-color: #5a5; color: #8f8; }
  .btn.unreject:hover { background: #242; }
  .btn.toggle { padding: 6px 12px; }
  .btn.toggle.active { background: #335; border-color: #7eb8f7; }
  tr.rejected td:first-child a { color: #f88; text-decoration: line-through; }

  /* Alphabet selector */
  .alphabet-bar {
    display: flex;
    gap: 2px;
    flex-wrap: wrap;
    margin-bottom: 15px;
  }
  .letter-btn {
    padding: 6px 10px;
    border: 1px solid #444;
    background: #222;
    color: #888;
    border-radius: 4px;
    cursor: pointer;
    font-size: 13px;
    min-width: 32px;
    text-align: center;
  }
  .letter-btn:hover { background: #333; color: #eee; }
  .letter-btn.active { background: #335; border-color: #7eb8f7; color: #7eb8f7; }
  .letter-btn.disabled { opacity: 0.3; cursor: default; }
  .letter-btn .letter-count {
    font-size: 10px;
    color: #666;
    display: block;
    margin-top: 2px;
  }
  .letter-btn.active .letter-count { color: #7eb8f7; }

  .loading {
    text-align: center;
    padding: 40px;
    color: #888;
  }
</style>
</head>
<body>
<h1>FTS: Fonts To Strokes</h1>
<p class="subtitle">
  <span id="totalCount">Loading...</span> total fonts{% if show_rejected %} (rejected){% endif %}
  <br>
  <span id="fontCount">Select a letter to browse fonts</span>
</p>

<div class="alphabet-bar" id="alphabetBar">
  <!-- Populated by JavaScript -->
</div>

<div class="controls">
  <input type="text" id="search" placeholder="Filter..." oninput="filterFonts()">
  {% if show_rejected %}
    <a href="/" class="btn toggle active">Showing Rejected</a>
  {% else %}
    <a href="/?rejected=1" class="btn toggle">Show Rejected</a>
  {% endif %}
  <a href="/data-management" class="btn" style="border-color:#a7f;color:#c9f;">Data Management</a>
  <span id="statusMsg" style="color:#888;font-size:13px;"></span>
</div>

<div id="loadingMsg" class="loading" style="display:none;">Loading fonts...</div>

<table id="fontTableContainer" style="display:none;">
  <thead><tr>
    <th class="sortable" data-col="0" data-type="text" onclick="sortTable(this)">Font</th>
    <th>Sample</th>
    <th class="sortable" data-col="2" data-type="text" onclick="sortTable(this)">Source</th>
    <th class="sortable" data-col="3" data-type="num" onclick="sortTable(this)">Characters</th>
    <th></th>
  </tr></thead>
  <tbody id="fontTable">
  </tbody>
</table>

<script>
const showRejected = {{ 'true' if show_rejected else 'false' }};
let currentLetter = null;
let letterCounts = {};
let allFonts = [];

// Build alphabet bar
function buildAlphabetBar() {
  const bar = document.getElementById('alphabetBar');
  const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ#'.split('');

  letters.forEach(letter => {
    const btn = document.createElement('button');
    btn.className = 'letter-btn';
    btn.dataset.letter = letter;
    btn.innerHTML = `${letter}<span class="letter-count">-</span>`;
    btn.onclick = () => selectLetter(letter);
    bar.appendChild(btn);
  });
}

// Update letter counts in the bar
function updateLetterCounts(counts) {
  letterCounts = counts;
  let total = 0;
  document.querySelectorAll('.letter-btn').forEach(btn => {
    const letter = btn.dataset.letter;
    const count = counts[letter] || 0;
    total += count;
    btn.querySelector('.letter-count').textContent = count;
    if (count === 0) {
      btn.classList.add('disabled');
    } else {
      btn.classList.remove('disabled');
    }
  });
  document.getElementById('totalCount').textContent = total.toLocaleString();
}

// Select a letter and load fonts
async function selectLetter(letter) {
  if (currentLetter === letter) return;

  // Update active state
  document.querySelectorAll('.letter-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.letter === letter);
  });

  currentLetter = letter;

  // Show loading
  document.getElementById('loadingMsg').style.display = 'block';
  document.getElementById('fontTableContainer').style.display = 'none';
  document.getElementById('fontCount').textContent = 'Loading...';

  try {
    const params = new URLSearchParams({letter});
    if (showRejected) params.append('rejected', '1');

    const resp = await fetch(`/api/fonts-by-letter?${params}`);
    const data = await resp.json();

    allFonts = data.fonts;
    updateLetterCounts(data.letter_counts);
    renderFonts(allFonts);

    document.getElementById('fontCount').textContent =
      `${allFonts.length} fonts starting with "${letter}"`;

  } catch (e) {
    console.error('Error loading fonts:', e);
    document.getElementById('fontCount').textContent = 'Error loading fonts';
  }

  document.getElementById('loadingMsg').style.display = 'none';
  document.getElementById('fontTableContainer').style.display = 'table';
}

// Render fonts to table
function renderFonts(fonts) {
  const tbody = document.getElementById('fontTable');
  tbody.innerHTML = '';

  fonts.forEach(f => {
    const tr = document.createElement('tr');
    tr.dataset.name = f.name.toLowerCase();
    tr.dataset.id = f.id;

    tr.innerHTML = `
      <td><a href="/font/${f.id}">${escapeHtml(f.name)}</a></td>
      <td><img class="font-sample" src="/api/font-sample/${f.id}" loading="lazy" alt=""></td>
      <td class="source">${f.source || ''}</td>
      <td class="count">${f.char_count}</td>
      <td>
        ${showRejected
          ? `<button class="btn unreject" onclick="unrejectFont(${f.id}, this)">Restore</button>`
          : `<button class="btn reject" onclick="rejectFont(${f.id}, this)">Reject</button>`
        }
      </td>
    `;
    tbody.appendChild(tr);
  });
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function sortTable(th) {
  const col = parseInt(th.dataset.col);
  const type = th.dataset.type;
  const tbody = document.getElementById('fontTable');
  const rows = Array.from(tbody.querySelectorAll('tr'));

  const isAsc = th.classList.contains('sort-asc');
  const dir = isAsc ? -1 : 1;

  document.querySelectorAll('th.sortable').forEach(h => {
    h.classList.remove('sort-asc', 'sort-desc');
  });
  th.classList.add(isAsc ? 'sort-desc' : 'sort-asc');

  rows.sort((a, b) => {
    const aCell = a.cells[col];
    const bCell = b.cells[col];
    let aVal = aCell ? aCell.textContent.trim() : '';
    let bVal = bCell ? bCell.textContent.trim() : '';

    if (type === 'num') {
      aVal = parseFloat(aVal) || 0;
      bVal = parseFloat(bVal) || 0;
      return (aVal - bVal) * dir;
    } else {
      return aVal.localeCompare(bVal) * dir;
    }
  });

  rows.forEach(row => tbody.appendChild(row));
}

function filterFonts() {
  const q = document.getElementById('search').value.toLowerCase();
  document.querySelectorAll('#fontTable tr').forEach(tr => {
    tr.style.display = tr.dataset.name.includes(q) ? '' : 'none';
  });
}

function rejectFont(fontId, btn) {
  if (!confirm('Reject this font?')) return;
  fetch(`/api/reject/${fontId}`, {method: 'POST'})
    .then(r => r.json())
    .then(d => {
      if (d.ok) {
        const tr = btn.closest('tr');
        tr.style.display = 'none';
      }
    });
}

function unrejectFont(fontId, btn) {
  fetch(`/api/unreject/${fontId}`, {method: 'POST'})
    .then(r => r.json())
    .then(d => {
      if (d.ok) {
        const tr = btn.closest('tr');
        tr.style.display = 'none';
      }
    });
}

// Initialize
buildAlphabetBar();

// Load initial letter counts without loading fonts
fetch(`/api/fonts-by-letter?letter=A${showRejected ? '&rejected=1' : ''}`)
  .then(r => r.json())
  .then(data => {
    updateLetterCounts(data.letter_counts);
  });
</script>
</body>
</html>
